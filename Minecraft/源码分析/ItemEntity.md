# 物品合并机制

> *Version:1.20.1*

## 名词解释

1. 实体存活时间 (Age)  
   - 服务器关闭**会**清零  
   - 初始值为**1**  
   - 每gt自增  
2. 物品实体存活时间 (ItemAge)  
   - 服务器关闭**不会**清零  
   - 初始值为**0**  
   - 每gt自增

## 合并时机

*在每个游戏刻（gt）检查物品移动后的坐标（x, y, z）与原先的坐标是否在任意一轴上移动超过1个单位。*

- 如果任意一轴上的移动距离超过1个单位：
  - 判断物品 *实体存活时间* 是2的倍数才能进行合并
- 如果任意一轴上的移动距离不超过1个单位：
  - 判断物品 *实体存活时间* 是40的倍数才能进行合并

## 合并检查

- 检查物品的拾取延迟（Pickup Delay）是否不等于32767（Short类型最大值）。
- 检查物品的 *物品实体存活时间* 是否不等于-32768（Short类型最小值）。
- 检查物品的 *物品实体存活时间* 是否小于6000。
- 检查物品的堆叠数量是否小于该物品类型的最大堆叠数量。

## 尝试合并

- 查找在物品的碰撞箱xz轴分别扩展0.5个单位后的Box内的所有可以合并的物品。
- 对于每一个找到的物品，执行以下检查：
  - 检查两个物品的拥有者（自定义nbt标签内Owner）是否一致。
  - 检查两个物品是否是同类物品。
  - 检查两个物品的堆叠数量之和是否小于或等于该物品类型的最大堆叠数量。
  - 如果物品有NBT数据，检查两个物品的NBT数据是否相同。

## 合并操作

- 物品实体向物品数量多的那一个物品实体合并
- 新的物品实体的拾取延迟取两个物品中较大的拾取延迟。
- 新的物品实体的 *物品实体存活时间* 取两个物品中较小的存活时间。

<p align="right"><font size=0.1>by Fanzhitianyu@Lazyalienserver.top</font></p>