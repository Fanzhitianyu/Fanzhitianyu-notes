# 漏斗 方块实体 容器 不可推动 不可充能 TE元件

1. 漏斗的行为（都是主动操作）
   
  - 吸取物品
    - 输入为 容器
    - 输入 物品实体(掉落物)
  - 输出物品
    - 输出为容器
2. 漏斗的状态
  - Locked (红石块充能漏斗以锁住)
    - 锁住 
      - 漏斗不进行任何主动操作（例如主动吸取物品或输出物品）
      - 漏斗冷却计数不受影响 （冷却计数后续会提到）
    - 未锁住
      - 漏斗可以进行主动操作 （如果有可进行的主动操作）
  - 输出指向 
    - 下方
    - 东方
    - 北方
    - 南方
    - 西方
  - 传输冷却 
    1. 传输冷却情况下不会进行任何主动行为
    2. 传输冷却计数
      1. 进行主动操作后会进行冷却
      2. 传输冷却计数一般为8
      3. 如果传输冷却计数小于等于0，则冷却解除
      4. 每gt冷却计数都会递减

3. 漏斗的运行流程

  1. 运算位置：在实体运算之后进行方块实体（包含漏斗）的运算
  2. 运算流程：
    1. 传输冷却计数减一
    2. 重置最后计算时间为当前时间
    3. 判断冷却计数是否小于等于0，如果是则进行后续流程，否则结束流程
    4. 传输冷却计数重置为0（目的是防止传输冷却计数变成-114514）
    5. 进行插入和提取流程
  3. 插入和提取流程（进行主动操作）
    1. 判断漏斗是否被锁，没锁则进行后续流程，锁了则结束流程
    2. 插入逻辑
      1. 漏斗会找输出方向所朝向的容器进行传输
      2. 如果漏斗输出方向容器已满，则不进行后续查找可传输物
      3. 查找可传输物是有序的，从第一格开始向后遍历
    3. 提取逻辑
      1. 如果漏斗已经满了则不进行后续提取逻辑
      2. 提取有两种逻辑，先进行提取容器中物品，再提取掉落物
        1. 只要顶上有容器,就不进行掉落物逻辑
        2. 容器包括（堆肥，箱子，漏斗矿车，等等）
      3. 提取容器中物品
        1. 选择提取容器
          1. 不同类型
            1. 方块容器（堆肥桶）
            2. 方块实体容器（箱子，等）
            3. 实体容器（漏斗矿车，等）
          2. 流程
            1. 方块容器和方块实体是只能其中一个
            2. 如果还能搜索到上方有实体容器则会覆盖方块容器或方块实体的存储栏
            3. 如果有多个实体容器则会随机选择一个实体容器
        2. 从容器中提取物品
          1. 如果容器是空的，则后续提取操作直接结束
          2. 然后按顺序提取
      4. 提取掉落物中物品
        1. 遍历上方所有物品
        2. 选择可以吸取的物品
        3. 一次最多提取一个itemStack（掉落物堆叠）
  4. 处理更新
    1. 如果有进行主动操作
    2. 重置冷却时间为8gt

4. 漏斗的优化
  1. 在其上方放堆肥桶可以减少部分卡顿（堆肥桶的存储格最少，优化能力最强）
  2. 空闲时或者不进行主动操作的漏斗锁住可以减少部分卡顿
  3. 如果加了锂，可以忽略上面的优化了（锂真是太强了）
5. 其他
  1. 主动操作和被动操作
    1. 主动操作就是当前漏斗进行的插入和提取操作，这些操作会导致重置冷却计数
    2. 被动操作就是其它漏斗对当前漏斗进行的插入或提取操作，这些操作不会重置冷却计数
  2. 不从掉落物中提取物品
    1. 1.21之前如果上方有容器则不进行从掉落物中提取物品的逻辑
    2. 1.21后如果在上方放置方块，如果方块没有DOES_NOT_BLOCK_HOPPERS标签，则也不进行从掉落物中提取物品的逻辑