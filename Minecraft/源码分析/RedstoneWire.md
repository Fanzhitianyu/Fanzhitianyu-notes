# RedStoneWireBlock分析参考笔记

---
>作者:Fanzhitianyu  
>版本:Fabric-1.18.2  
>所属:[LazyAlienServer](https://lazyalienserver.top)  
>感谢:tanh丶桁 —— Main部分的实验分析以及资料整理  
>**特别感谢**:czl的一篇小古文提醒我不要鸽子，甚至用他的桃花运给我许愿我真的哭死，呜呜呜，太感动了  

---

>*ps：文中若有错误，欢迎指出，谢谢！*  
>**本文解释红石粉部分运行流程，辅助分析红石粉机制。**
 
>**由于部分方法，解释出来过于繁琐，且我认为没有很大必要,我将不会解析其内容而是直接通过功能描述**

## Main

>*ps: Main部分文字来源于 [红石粉更新研究报告【MC刨根问底#1】](https://www.bilibili.com/read/cv25395934)*
---

### 连接性

**概念：** 该方向有红石粉与源红石粉相连接，包括玻璃下传（有连接但不传递信号），不包括被方块阻断。

### 红石粉的更新：pp nc prepare

常规pp更新：向毗邻的西东北南下上6个方块发出pp更新

### prepare更新

> `1.19 22w13a 以前` - 红石线放置、破坏、改变状态时，对它水平指向的任意方块，若它不是另一个红石线，则向它上下侧的方块（侦测器除外）发送PP更新。<p> `1.19 22w13a 及以后` - 红石线对斜上斜下的PP更新仅作用于其他红石线。</p><p align="right">——Minecraft WiKi 红石粉</p>

#### 性质
prepare更新**本质上是**：检查方块和状态并进行0~8次**pp更新**

#### 更新流程

源红石粉按照**北东南西**的顺序依次进行以下步骤：

1. 检查连接性，连接性成立则继续
2. 检查该方向毗邻方块下方是否为侦测器，若不是侦测器，则向该方向毗邻方块下方发送pp更新
3. 同2，其中方向变为上方

### NC更新

#### 更新流程
>红石粉执行二阶毗邻更新：源红石粉本身及其毗邻的6个方块作为7个更新源，各向西东下上北南六个方向发出总计6*7=42次nc更新  

#### 更新源顺序
>7个更新源的先后顺序是基于红石粉坐标的哈希信息随机排列的，其顺序见下表。这些更新源有97%的概率被分为三组。 

*注：表中O表示源红石粉，-X等表示更新源相对于源红石粉的方位*

| 组别1 | 组别2 | 组别3 | 概率 |
| :---: | :---: | :---: | :---: |
| -Y, +Z, +X | O | +Y, -Z, -X | 24.267% |
| +Y, -Z, -X | O | -Y, +Z, +X | 24.267% |
| O | -Y, +Z, +X | +Y, -Z, -X | 12.133% |
| O | +Y, -Z, -X | -Y, +Z, +X | 12.133% |
| -Y, +Z, +X | +Y, -Z, -X | O | 12.133% |
| +Y, -Z, -X | -Y, +Z, +X | O | 12.133% |
||其他各项||<0.2%|

各组别内的更新顺序是固定的，但组别排列顺序随机。除此之外，还有一些其他的概率极低的排列选项。

### 总更新流程

#### 受到NC更新

红石粉受到**nc更新**时检查自身**能量等级**

>1.改变自身能量等级 -> 周围与自身有连接的红石粉的最大能量值减一（即max-1）  
>2.发送prepare更新  
>3.发送pp更新  
>4.发送prepare更新  
>5.发送nc更新

#### 受到PP更新

>红石粉受到**pp更新**时检查自身**连接状态**

>1. 改变连接状态side  
>2. 发送prepare更新  
>3. 发送pp更新  
>4. 发送prepare更新  

### 常见“更新次数”解释

#### “42次更新”

指的是红石粉及其毗邻的7个更新源发出的总计**42次**nc更新

#### “最多22次更新”

指的是红石粉发出的两次prepare更新（包含最多8*2=16次pp更新）及常规pp更新（6次）总计**最多22次**pp更新

---

## **代码分析及验证**

### 放置红石粉
>
>放置红石粉后  
>会检查当前的方块与之前方块是否相同（也就是判断原来这个位置是不是红石粉），如果是则跳过后续步骤  
>如果方块不同则，对其进行 [*更新*](#更新)  
>然后进行遍历 进行NC更新 [{更新顺序}](#updateneighborsalways) 垂直的两个方向[VERTICAL](#vertical)  
>然后进行 [偏移更新](#updateoffsetneighbors)

### NC更新
>
>先检查是否可放置，若是可以则对其 [*更新*](#更新)。  
>如果不是能放置则掉落红石粉
>

### PP更新
>
>PP更新会检查PP来源，若是下方传来的PP则会将当前状态返回，不予理会。若是上方传来的PP则会去[检查连接](#getplacementstate方法)  
>
>后面就是判断连接之类的，最后返回新的state
>

### Prepare更新
>
>这个更新是一个比较特殊的更新，很少有说，但是在改变红石粉能量的时候确实会用到。从功能来说是解决四周上下连接状态用的。
>
---
>
>[prepare更新流程](#prepare更新)  
>这里就不多说了，和之前tanh文档中的一致
>

### 更新
>
>>*怎么说呢，个人认为这个才是红石粉NC更新的主体,也是常说的红石粉二阶毗邻更新,但是还有一些其他方法调用了他所以就单独列出来了*
>---------
>1.更新先判断能量等级是否变化[判断 [收到的红石信号](#收到的红石信号) 和当前信号是否相等]。  
>2.更新红石粉能量[以及 [prepare更新](#prepare更新) 和 [PP更新](#pp更新) ]  
>3.通过hashset打乱周围六个方向的更新顺序  
>4.遍历方向，进行NC更新 [{更新顺序}](#updateneighborsalways)  
>>{能量变化的更新顺序是[prepare更新](#prepare更新)->[PP更新](#pp更新)->[prepare更新](#prepare更新)->[NC更新](#nc更新)}  
>红石指向会影响prepare发出的特殊更新，只有红石粉所指向的方向才会有prepare的PP更新(实验检测，暂未通过代码论证)
>
### 收到的红石信号
>
>

### getPlacementState方法
>
>>是用来确定连接的
>---
> 其中调用了[获取红石连接](#getdefaultwirestate方法)  
>没啥好讲的，就是连接嘛，都知道怎么连doge
>

### getDefaultWireState方法
>
>*获取红石连接*
>
>---
>
>没啥好说的感觉，就正常的判断水平方向的连接，还有上方方块的压线
>
>>*`ps:`应该就是用来判断是否压线*
>

### canRunOnTop
>
>如果对应方块上方可以放置，或者方块是漏斗则返回正确
>

### connectsTo
>
>判断当前方向是否有连接  
>
>---
>
>1.判断方块是否为红石粉如果是则返回true  
>2.若是中继器返回判断正反是否与连接方向一致,返回true  
>3.若是侦测器返回判断朝向是否与连接方向一致,返回true  
>4.若都不是则判断是否能发出红石信号，若可以，并且连接方向不为空，返回true

### updateOffsetNeighbors
>
>**偏移更新**
>
>---
>
>首先，会在水平四个方向进行 [检测](#updateneighbors)  
>然后再次遍历水平四个方向判断四个方向是否有实体方块  
>若有则对其上方进行 [检测](#updateneighbors)  
>若无则对其下方进行 [检测](#updateneighbors)  

### updateNeighbors
>
> **使周围红石粉发出NC更新**  
>
>---
>
>先检查当前位置是否是红石粉  
>若不是则跳过后面步骤，若是则继续
>然后NC更新周围六个方向 ->[{更新顺序}](#updateneighborsalways)  
>然后再把六个方向作为更新子核->[{子核顺序}](#all)  
>每个子核再向六个方向发出NC更新->[{更新顺序}](#updateneighborsalways)  
---
>*ps:上面这部分其实也就是二阶毗邻，但是和正常NC更新不同的是，它有一定顺序的，并不是通过hashset打乱的*

### 方向

#### ALL
>
>`ALL` [DOWN, UP, NORTH, SOUTH, WEST, EAST]  
>
#### HORIZONTA
>
>`HORIZONTA` [NORTH, EAST, SOUTH, WEST]  
>
#### VERTICAL
>
>`VERTICAL` [UP, DOWN]  
>
#### updateNeighborsAlways
>
>`updateNeighborsAlways` [WEST, EAST, DOWN, UP, NORTH, SOUTH]  
>

---
<p align="right"><font size=0.1>by LazyAlienServer</font></p>